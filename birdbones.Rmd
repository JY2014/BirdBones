---
title: "Bird Bones and Living Habits"
author: "JY"
output: html_document
---


```{r}
library(knitr)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(grid)
library(scatterplot3d)
```


```{r, include=FALSE}
setwd('C:/Users/JY/Documents/GitHub/Kaggle/BirdBones')
```

##1. Data Exploration
The dataset contains ecological classification of birds and the measure (length and diameter) of five pieces of bones on the wings and legs. Let's first check the size and content of the data.
```{r}
# load the data
bird.data <- read.csv("bird.csv")
# check the dimension
n.row <- nrow(bird.data)
n.col <- ncol(bird.data)
print (paste0("# of predictors: ", n.col))
print (paste0("# of observations: ", n.row))
# show how the data look like
kable(bird.data[1:5, ])
```

There are 7 observations with missing values among the total 420 observations. Due to the samll proportion of missing values, We can just remove those 7 data points from our analysis. 
```{r}
# remove samples with missing values (7 in 420)
data.complete <- bird.data[rowSums(is.na(bird.data)) == 0, ]
```


###1.1. Check the balance between classes

For classification problems, it is important to check the proportion of each class. Severe imbalance of the classes can cause difficulties for correctly classifying the classes with smaller numbers of observations. 
```{r, cache=TRUE, fig.width=6, fig.height=6}
# compute count for each class
data.count <- melt(table(data.complete[, n.col]))
# class label
label <- c("Scansorial", "Raptors", "Singing", "Swimming", "Terrestrial", "Wading")
# commpute percentage
percent <- rev(data.count$value/sum(data.count$value))
# compute label position
position <- cumsum(rev(data.count$value)) - 0.5*rev(data.count$value)

# check the number of birds in each class
ggplot(data=data.count, aes(x=factor(1), y=value, fill = Var1)) +
  geom_bar(width = 1, stat = "identity")+
  coord_polar(theta = "y") +
  geom_text(aes(label = sprintf("%1.2f%%", 100*percent), y = position)) +
  scale_fill_brewer(palette = "Set2", name = c("Living Habit"),
                    label = label) +
  ggtitle("Figure 1. Proportion of Birds with Different Living Habits") +
  theme(plot.title = element_text(hjust = 0.5, size = 14))
```

###1.2. Check how each bone measure is related to the ecological classes
We can roughly plot the trend of each bone measure in the different classes, in order to check whether different classes are related to different lenght and diameter of the bones. 
```{r}
# function to plot a measure by class
bone.plot <- function(data, var){
  p <- ggplot(data, mapping = aes_string(x = "type", y = var)) +
        geom_boxplot() +
        ggtitle(var) +
        scale_x_discrete(labels=c("Scansorial", "Raptors", "Singing", 
                                  "Swimming", "Terrestrial", "Wading")) +
        ggtitle(var)+
        theme(plot.title = element_text(size = 14))
  return (p)
}
```
```{r, cache=TRUE, fig.width=8, fig.height=12}
# plot for each bone measure
plots <- list()
for (i in 1:(n.col - 2)){
  name <- names(data.complete)[i+1]
  plots[[i]] <- bone.plot(data.complete, name)
}
do.call(grid.arrange, c(plots, ncol=2))
```

It is interesting to notice that the difference among classes is very similar across different bone measures. Scansorial, singing and terrestrial birds tend to have lower bone lengths and diameters with smaller variance. The other three classes have higher measure values and large variance. The result is consistent with high correlation between bone measures (shown in 1.3). The visual difference between classes on the plots suggests potential classification using the information of the bones.  

###1.3. Correlation Between Predictors
As the sizes of bones in the same bird are natually correlated with each other to certain extent due to the overall size of the bird, it is highly likely that the bone measures are correlated. However, correlation between predictors lead to multicollinearity problem for models. Let's first confirm whether there is strong correlation between the predictors. 
```{r, cache=TRUE}
#correlation between predictors
cor.matrix <- cor(data.complete[, 2:(n.col-1)])
# plot heatmap
melted_cormat <- melt(cor.matrix)
```
```{r, fig.width=5, fig.height=4, cache = TRUE}
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()+
  scale_fill_continuous(low = "azure", high = "steelblue", 
                        name = "Correlation") +
  ggtitle("Figure 3. Correlation Between the Bone Measures") +
  theme(plot.title = element_text(hjust = 0.5, size = 14))
```

The above heatmap clearly demonstrates the strong correlation between the bone measures. Some of the bones also seem to correlate together more than others, such as humerus and ulna (both are on the wings).

In order to avoid the multicollinearity problem, we can use principal component analysis to decompose the predictors into orthogonal variables.  


##2. Principal Component Analysis (PCA)
```{r}
# perform PCA
pca <- prcomp(data.complete[2:(n.col-1)], scale=T)
```

###2.1. Variance Explained by Each Principal Component
```{r, cache=TRUE, fig.width=5, fig.height=4}
# check the variance explained by each PC
# total variance of the data
total.var <- sum(pca$sdev^2)
# compute %variance explained by each PC
percent.var <- pca$sdev^2/total.var
# cumulative variance explained
cum.percent <- c()
for (i in 1:(n.col-2)){
  cum.percent <- c(cum.percent, sum(percent.var[1:i]))
}
# plot the accumulative variance against # of PCs
df <- data.frame(percent = cum.percent, 
                 num.PC = seq(1, n.col-2, 1))
ggplot(df, aes(x = num.PC, y = percent))+
  geom_point()+
  geom_line()+
  ggtitle("Figure 4. Cumulative Variance Explained by Principal Components")+
  theme(plot.title = element_text(hjust = 0.5, size = 11))+
  xlab("Number of Principal Components")+
  ylab("Percentage of Variance Explained")
```

Consistent with high correlation among bone measures, the first principal component explains 85% of the variance. The first three principal components explain over 95% of the variance. 

###2.2. How the Principal Components Represent the Bone Measures
```{r, fig.width=8, fig.height=6, cache=TRUE}
score <- data.frame(pca$rotation)
score$names <- rownames(score)
score.df <- melt(score, value.name = "score")

ggplot(score.df, aes(x = names, y = score))+
  geom_bar(stat = "identity")+
  coord_flip()+
  facet_wrap(~ variable)+
  ggtitle("Figure 5. Bone Measures Represented by Each Principal Component")+
  theme(plot.title = element_text(hjust = 0.5, size = 14))+
  ylab("Bone measures")
```

The first principal component captures the common trend among the bone measures. The later principal components start to pick up smaller difference among the measures. 

###2.3. Visualize the Ecological Classes on the First Two PCs
```{r, cache=TRUE, fig.width=12, fig.height=5}
# combine the PCs with class label into a df
pca.df <- data.frame(pca$x)
pca.df$type <- data.complete$type
# plot and color by sample type
p1<- ggplot(pca.df, aes(x = PC1, y = PC2, color = type)) +
  geom_point() +
  scale_color_discrete(name = "Ecological Class", labels = label)+
  ggtitle("6a. Ecological Classes Shown by PC1 and PC2")+
  theme(plot.title = element_text(size = 11)) 
p2<- ggplot(pca.df, aes(x = PC3, y = PC4, color = type)) +
  geom_point() +
  scale_color_discrete(name = "Ecological Class", labels = label)+
  ggtitle("6b. Ecological Classes Shown by PC3 and PC4")+
  theme(plot.title = element_text(size = 11))
grid.arrange(p1, p2, ncol=2, 
  top = textGrob("Figure 6. Ecological Classes Shown by Principal Components", 
                gp=gpar(fontsize=14, fontface = 'bold')))
```

We can see from the above plots that the ecologial classes are hard to be separated by the principal components. Consistent with the previous boxplots of the bone measures, three types of birds (raptors, swimming and wading) have higher variance compared to the other three types. It makes sense for the birds to share similar bone characteristics even if they have very different living habits, especially when some of the living habits may co-exist in a brid.  For example, the singing birds may share the bone measures of scansorial birds if they also climb trees.

**Since it is hard to set distinct living habits for some of the groups, it is also hard to classify the birds according to the living habits. Instead, we can use some of the living habits that do not co-exist in birds to perform the classification.** For example, the water birds and non-water birds can be a distinct and clear classification. In order to perform the following classification, the ecological classes are further grouped as follows:

* **Water birds**: including swimming and wading birds
* **Others**: other classes

The water birds are characterized by the higher bone measure variance compared to other birds. The two groups are largely separable on the following plot.

```{r}
# assign new types to the data
pca.df$new.type <- "Other"
pca.df$new.type[pca.df$type == "SW" | pca.df$type == "W"] <- "Water"
pca.df$new.type <- as.factor(pca.df$new.type)
```

```{r, cache=TRUE, fig.width=5, fig.height=5}
# 3-D plot to visualize the two groups
colors = c("red", "blue")
colors <- colors[as.numeric(pca.df$new.type)]

plot <- scatterplot3d(pca.df[c(2:4)], 
            color = colors, angle = 60, pch = 1,
            main = "Figure 7. Water v.s Other Birds by the PC 2-4")

legend(plot$xyz.convert(-4, 2, 2), legend = levels(pca.df$new.type),
      col = c("red", "blue"), pch =1)

```

Although there is still overlap between the two groups, we can try classification models on the data based on these two ecological distinct groups. 

##3. Classification by Support Vector Machines
Let's first check the balance between these two groups:

###3.1. Baseline by Random Forest

###3.2. Support Vector Machines



